[参考地址](https://mp.weixin.qq.com/s/AP_m0QqKgzEUfjf0PQCX-w)
# 前期准备

## 安装jdk
```
yum install -y java-1.8.0-openjdk.x86_64 java-1.8.0-openjdk-demo  java-1.8.0-openjdk-devel java-1.8.0-openjdk-javadoc
```

1. hostname及hosts配置

集群中各个节点之间能互相通信使用静态IP地址。IP地址和主机名通过/etc/hosts配置，主机名/etc/hostname进行配置（推荐hostname使用FQDN完全域名的方式配置）。

* hostname配置

修改/etc/hostname文件：

> vim /etc/sysconfig/network

```
修改的主机名
```

<font color=red>注意：修改hostname后需要重启服务器。</font>

检查hostname是否修改成功：

> hostname

## 自定义主机名


* hosts配置

> vim /etc/hosts
```
127.0.0.1               localhost.localdomain localhost
::1             localhost6.localdomain6 localhost6

172.31.6.148  ip-172-31-6-148.fayson.com
172.31.5.190  ip-172-31-5-190.fayson.com
172.31.10.118 ip-172-31-10-118.fayson.com
172.31.9.33   ip-172-31-9-33.fayson.com

```


以上两步操作，在集群中其它节点做相应配置。

## 禁用SELinux
在所有节点执行

> sudo setenforce 0

修改集群所有节点的/etc/selinux/config文件，内容如下：

> vim /etc/selinux/config 

```
SELINUX=disabled
# SELINUXTYPE= can take one of these twovalues:
#     targeted - Targeted processes areprotected,
#     mls - Multi Level Securityprotection.
SELINUXTYPE=targeted

```


## 关闭防火墙

在集群所有节点执行如下操作，并永久关闭防火墙

> systemctl stop firewalld

4. 配置操作系统本地yum源

## 安装http服务

在集群其中一节点上安装http服务，执行如下命令：

> yum -y install httpd

* 将httpd服务加入系统自启动服务并设置开机启动

## 集群时钟同步

在集群的所有服务器上安装ntp服务，用于集群时钟同步
> yum -y install ntp

将ntpd加入系统自启动服务并设置开机启动

在参照服务器上配置与自己同步

> vim /etc/ntp.conf 

[参考](https://github.com/wjn0918/Study/blob/master/BigData/images/cloudera/ntp_master.conf)

集群其它节点配置如下
注释掉server，添加自己的server

[参考](https://github.com/wjn0918/Study/blob/master/BigData/images/cloudera/ntp_slave.conf)

手动同步一次时间

> /usr/sbin/ntpdate master

重启集群所有节点的ntpd服务

> systemctl restart ntpd

验证时钟同步，在所有节点执行

> ntpq -p

有“*”显示则表示同步成功。需要等会

## 安装MySQL

> yum -y install mysql mysql-server

将mysqld加入系统自启动服务并设置开机启动

> chkconfig --add mysqld  
chkconfig mysqld on

启动并配置Mysql

> systemctl start mysqld

### 更改密码策略

在/etc/my.cnf配置文件中增加

[mysqld]
validate_password=off


SHOW VARIABLES LIKE 'validate_password%'; 

https://www.jianshu.com/p/5779aa264840


更改密码策略为LOW   
set global validate_password_policy=0;

更改密码长度

set global validate_password_length=0;

初始化MySQL

>  mysql_secure_installation

开启远程访问

```
grant all on *.* to root@'%' identified by '密码' with grant option;
flush privileges;
```

创建CM及CDH服务的数据库

```
create database metastore default character set utf8;
CREATE USER 'hive'@'%' IDENTIFIED BY 'hive';
GRANT ALL PRIVILEGES ON metastore. * TO 'hive'@'%' IDENTIFIED by 'hive';
FLUSH PRIVILEGES;

create database cm default character set utf8;
CREATE USER 'cm'@'%' IDENTIFIED BY 'cm';
GRANT ALL PRIVILEGES ON cm. * TO 'cm'@'%' IDENTIFIED by 'cm';
FLUSH PRIVILEGES;

create database am default character set utf8;
CREATE USER 'am'@'%' IDENTIFIED BY 'am';
GRANT ALL PRIVILEGES ON am. * TO 'am'@'%' IDENTIFIED by 'am';
FLUSH PRIVILEGES;

create database rm default character set utf8;
CREATE USER 'rm'@'%' IDENTIFIED BY 'rm';
GRANT ALL PRIVILEGES ON rm. * TO 'rm'@'%' IDENTIFIED by 'rm';
FLUSH PRIVILEGES;

create database hue default character set utf8;
CREATE USER 'hue'@'%' IDENTIFIED BY 'hue';
GRANT ALL PRIVILEGES ON hue. * TO 'hue'@'%' IDENTIFIED by 'hue';
FLUSH PRIVILEGES;

create database oozie  default character set utf8;
CREATE USER 'oozie'@'%' IDENTIFIED BY 'oozie';
GRANT ALL PRIVILEGES ON oozie. * TO 'oozie'@'%' IDENTIFIED by 'oozie';
FLUSH PRIVILEGES;
```

# Cloudera Manager安装


1. 配置CM本地repo源

CM5.12.1下载地址：

http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.12.1/RPMS/x86_64/cloudera-manager-agent-5.12.1-1.cm5121.p0.6.el6.x86_64.rpm
http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.12.1/RPMS/x86_64/cloudera-manager-daemons-5.12.1-1.cm5121.p0.6.el6.x86_64.rpm
http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.12.1/RPMS/x86_64/cloudera-manager-server-5.12.1-1.cm5121.p0.6.el6.x86_64.rpm
http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.12.1/RPMS/x86_64/cloudera-manager-server-db-2-5.12.1-1.cm5121.p0.6.el6.x86_64.rpm
http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.12.1/RPMS/x86_64/enterprise-debuginfo-5.12.1-1.cm5121.p0.6.el6.x86_64.rpm
http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.12.1/RPMS/x86_64/jdk-6u31-linux-amd64.rpm
http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.12.1/RPMS/x86_64/oracle-j2sdk1.7-1.7.0+update67-1.x86_64.rpm

将以上7个文件下载至服务器的/var/www/html/cm5.12.1目录下

在/var/www/html/cm5.12.1目录下执行命令

> createrepo 

确认http是否能正常访问

在/etc/yum.repo.d/目录下增加cm.repo文件，内容如下

```
[cloudera-manager]
name = Cloudera Manager, Version 6.2.1
baseurl =  http://master/cdh6.2.1/
baseurl = file:///opt/cm
gpgcheck = 0
```

[cloudera manager]
name=CM6.12
baseurl=file:///var/www/html/cm
gpgcheck=false
enabled=true



验证CM源是否配置成功

yum repolist

2. 配置http访问CDH Parcel包

https://archive.cloudera.com/cdh6/

CDH5.12.1下载地址：

http://archive.cloudera.com/cdh5/parcels/5.12.1/CDH-5.12.1-1.cdh5.12.1.p0.3-el6.parcel
http://archive.cloudera.com/cdh5/parcels/5.12.1/CDH-5.12.1-1.cdh5.12.1.p0.3-el6.parcel.sha1
http://archive.cloudera.com/cdh5/parcels/5.12.1/manifest.json

将以上3个文件下载至/var/www/html/cdh5.12.1目录下

确认http是否能正常访问

3. 安装Cloudera Manager Server

> yum -y install cloudera-manager-server

4. 初始化CM数据库

/opt/cloudera/cm/schema/scm_prepare_database.sh mysql cm cm cm

mysql  - 数据库类型  
cm -数据库名  
cm -登陆用户  
cm -密码  


# 下载地址

[cdh5](http://archive.cloudera.com/cdh5/parcels/latest/)


# 安装

1. 启动httpd
```
yum install httpd
systemctl status httpd
systemctl start httpd
```
所属目录：/var/www/html

2. 创建/var/www/html/cdh{version}文件夹，进入
下载对应版本rpm包
```
https://archive.cloudera.com/cm6/6.2.1/redhat7/yum/RPMS/x86_64/
wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-agent-5.11.1-1.cm5111.p0.9.el6.x86_64.rpm
wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-daemons-5.11.1-1.cm5111.p0.9.el6.x86_64.rpm
wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-server-5.11.1-1.cm5111.p0.9.el6.x86_64.rpm
wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-server-db-2-5.11.1-1.cm5111.p0.9.el6.x86_64.rpm
wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/enterprise-debuginfo-5.11.1-1.cm5111.p0.9.el6.x86_64.rpm
wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/jdk-6u31-linux-amd64.rpm
wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/oracle-j2sdk1.7-1.7.0+update67-1.x86_64.rpm
```


3. 下载createrepo

yum install createrepo

4. 进入/var/www/html/cdh{version}文件夹
```
createrepo  .
```

5. 配置/etc/yum.repos.d/cloudera-manager.repo文件，内容如下
```
[cloudera-manager]
name = Cloudera Manager, Version 6.2.1
baseurl =  http://master/cdh6.2.1/
baseurl = file:///opt/cm
gpgcheck = 0
```

6. 测试yum源是否正常
```
yum clean  all
yum  makecache
```


7. 安装Cloudera Manager Server

yum -y install cloudera-manager-server



8. 初始化数据库

```
create database if not EXISTS metastore default character set utf8;
CREATE USER if not EXISTS 'hive'@'%' IDENTIFIED BY 'hive';
GRANT ALL PRIVILEGES ON metastore. * TO 'hive'@'%' IDENTIFIED by 'hive';
FLUSH PRIVILEGES;

create database if not EXISTS cm default character set utf8;
CREATE USER if not EXISTS 'cm'@'%' IDENTIFIED BY 'cm';
GRANT ALL PRIVILEGES ON cm. * TO 'cm'@'%' IDENTIFIED by 'cm';
FLUSH PRIVILEGES;

create database if not EXISTS am default character set utf8;
CREATE USER if not EXISTS 'am'@'%' IDENTIFIED BY 'am';
GRANT ALL PRIVILEGES ON am. * TO 'am'@'%' IDENTIFIED by 'am';
FLUSH PRIVILEGES;

create database if not EXISTS rm default character set utf8;
CREATE USER if not EXISTS 'rm'@'%' IDENTIFIED BY 'rm';
GRANT ALL PRIVILEGES ON rm. * TO 'rm'@'%' IDENTIFIED by 'rm';
FLUSH PRIVILEGES;

create database if not EXISTS hue default character set utf8;
CREATE USER if not EXISTS 'hue'@'%' IDENTIFIED BY 'hue';
GRANT ALL PRIVILEGES ON hue. * TO 'hue'@'%' IDENTIFIED by 'hue';
FLUSH PRIVILEGES;

create database if not EXISTS oozie  default character set utf8;
CREATE USER if not EXISTS 'oozie'@'%' IDENTIFIED BY 'oozie';
GRANT ALL PRIVILEGES ON oozie. * TO 'oozie'@'%' IDENTIFIED by 'oozie';
FLUSH PRIVILEGES;
```

/opt/cloudera/cm/schema/scm_prepare_database.sh mysql cm cm cm

* 初始化数据库  

/opt/cloudera/cm/schema/scm_prepare_database.sh mysql -h hadoop1 -utemp -ptemp --scm-host  hadoop1  databaseName dbUser dbPw

./scm_prepare_database.sh mysql -h master -P 3306 -u root -pWind@2019 --scm-host master scm root Wind@2019


[安装数据库](https://blog.csdn.net/SYXDWT/article/details/87887253)
cloudera-scm-agent start
[创建数据库并添加用户](https://blog.csdn.net/weixin_42194239/article/details/103048808)


##  添加mysql-connect.jar


将jar包放到/usr/share/java目录下

## 启动

> systemctl start cloudera-scm-server

10. 日志文件 
tail -f /var/log/cloudera-scm-server/clousera-scm-server.log

create database cm6 default character set utf8;
CREATE USER 'am'@'%' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON am. * TO 'am'@'%';
FLUSH PRIVILEGES;


systemctl restart cloudera-scm-server
systemctl stop cloudera-scm-server
systemctl status cloudera-scm-server
systemctl start cloudera-scm-server

systemctl start cloudera-scm-agent
systemctl status cloudera-scm-agent
systemctl restart cloudera-scm-agent
systemctl stop cloudera-scm-agent


http://archive.cloudera.com/cdh5/parcels/latest/








# 初始化数据库

修改vim /etc/cloudera-scm-server/db.properties
注释掉#com.cloudera.cmf.db.setupType=EXTERNAL
重启


